[config]
default_to_workspace = false
skip_core_tasks = true

[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true
KERNEL_TARGET = "x86_64-unknown-none"
BUILD_DIR = "build"
QEMU = "qemu-system-x86_64"
GDB = "gdb"
QEMU_GDB_PORT = "1234"
STRAT9_PROFILE = "debug"

# =============================================================================
# Build Tasks - limine bootloader
# =============================================================================

[tasks.setup-limine]
description = "Download and setup Limine bootloader"
command = "bash"
args = ["tools/scripts/setup-limine.sh"]


[tasks.patch-relibc]
description = "Verify/patch relibc Strat9 integration (source of truth: sdk/relibc)"
script_runner = "@shell"
script_extension = "sh"
script = [
    '''
    root_dir="$(pwd)"
    relibc_dir="$root_dir/sdk/relibc"
    platform_mod="$relibc_dir/src/platform/mod.rs"
    target_dir="$relibc_dir/src/platform/strat9"

    if [ ! -d "$relibc_dir" ]; then
        echo "ERROR: $relibc_dir not found. Run setup-relibc first."
        exit 1
    fi

    if [ ! -f "$target_dir/mod.rs" ] || [ ! -f "$target_dir/auxv_defs.rs" ]; then
        echo "ERROR: Strat9 PAL files must live in $target_dir (mod.rs + auxv_defs.rs)."
        echo "This repository is configured for Choice 1 (single source in sdk/relibc)."
        exit 1
    fi

    # Patch src/platform/mod.rs (idempotent with markers)
    echo "Patching $platform_mod..."

    # Remove any existing Strat9 blocks (idempotent removal)
    sed -i '/\/\/ STRAT9-OS-START/,/\/\/ STRAT9-OS-END/d' "$platform_mod"

    # Define the blocks to insert
    sys_block="// STRAT9-OS-START
#[cfg(all(not(feature = \"no_std\"), target_os = \"strat9\"))]
#[path = \"strat9/mod.rs\"]
pub(crate) mod sys;
// STRAT9-OS-END
"
    auxv_block="// STRAT9-OS-START
#[cfg(target_os = \"strat9\")]
pub use self::sys::auxv_defs;
// STRAT9-OS-END"

    modified=false
    # Insert sys block after redox sys.
    if grep -q 'redox/mod.rs.*pub(crate) mod sys' "$platform_mod"; then
        sed -i "/redox\/mod\.rs.*pub(crate) mod sys/a $sys_block" "$platform_mod"
        modified=true
    fi

    # Insert auxv block after redox auxv.
    if grep -q 'redox_rt::auxv_defs' "$platform_mod"; then
        sed -i "/redox_rt::auxv_defs/a $auxv_block" "$platform_mod"
        modified=true
    fi

    if [ "$modified" = true ]; then
        echo "Successfully patched $platform_mod with markers."
    else
        echo "ERROR: Could not find insertion points in $platform_mod"
        exit 1
    fi
    ''',
]

[tasks.setup-relibc]
description = "Clone/update external relibc fork and validate Strat9 PAL (Choice 1)"
script_runner = "@shell"
script = [
    '''
    root_dir="$(pwd)"
    relibc_dir="$root_dir/sdk/relibc"
    platform_mod="$relibc_dir/src/platform/mod.rs"
    target_dir="$relibc_dir/src/platform/strat9"

    if [ -d "$relibc_dir/.git" ]; then
        cd "$relibc_dir"
        git fetch origin
        git checkout strat9-os
        git pull origin strat9-os
    else
        rm -rf "$relibc_dir"
        git clone https://github.com/ggielly/relibc "$relibc_dir"
        cd "$relibc_dir"
        git checkout strat9-os
        git submodule update --init --recursive
    fi

    # Choice 1 is mandatory: Strat9 PAL lives directly in relibc fork.
    if [ ! -f "$target_dir/mod.rs" ] || [ ! -f "$target_dir/auxv_defs.rs" ]; then
        echo "ERROR: Missing $target_dir/mod.rs or $target_dir/auxv_defs.rs."
        echo "Choice 1 is enforced: maintain PAL only inside sdk/relibc."
        exit 1
    fi

    # Verify marker blocks are present in relibc platform registry.
    echo "Verifying $platform_mod has Strat9 markers..."
    if ! grep -q '// STRAT9-OS-START' "$platform_mod"; then
        echo "ERROR: Strat9 markers not found in $platform_mod. Please update your fork."
        exit 1
    fi

    echo "Successfully verified $platform_mod with Strat9 markers."
    ''',
]

# =============================================================================
# Build tasks - Relibc 
# =============================================================================

[tasks.check-relibc]
description = "Check relibc compilation for Strat9 target"
script_runner = "@shell"
script = ['''
echo "Checking relibc for x86_64-strat9 target..."
cd sdk/relibc
cargo check \
    --target ../../targets/x86_64-unknown-strat9.json \
    -Z build-std=core,alloc \
    -Z json-target-spec \
    --no-default-features
echo "Relibc check completed."
''']

[tasks.build-relibc]
description = "Build relibc static library for Strat9"
dependencies = ["setup-relibc"]
script_runner = "@shell"
script = ['''
echo "Building relibc for x86_64-strat9 target..."
cd sdk/relibc
cargo build \
    --target ../../targets/x86_64-unknown-strat9.json \
    --release \
    -Z build-std=core,alloc \
    -Z json-target-spec \
    --no-default-features

echo ""
echo "=== Relibc Build Complete ==="
echo ""
librelibc="../../target/x86_64-strat9/release/librelibc.a"
if [ -f "$librelibc" ]; then
    size=$(stat -c%s "$librelibc" 2>/dev/null || stat -f%z "$librelibc")
    size_kb=$((size / 1024))
    echo "  librelibc.a: $size bytes ($size_kb KB)"
    echo "  Location: target/x86_64-strat9/release/librelibc.a"
else
    echo "  Warning: librelibc.a not found"
fi
echo ""
''']

# Legacy bootloader (kept for reference, not used with Limine)
[tasks.assemble-bootloader]
description = "Assemble the bootloader (NASM stage1.asm which includes stage2.asm) - LEGACY"
command = "powershell"
args = [
    "-ExecutionPolicy",
    "Bypass",
    "-File",
    "tools/scripts/assemble-bootloader.ps1",
]

# =============================================================================
# Build tasks - Kernel 
# =============================================================================

[tasks.kernel]
description = "Build the Strat9 kernel (debug profile, symbols enabled)"
cwd = "workspace/kernel"
command = "cargo"
args = ["build", "--target", "${KERNEL_TARGET}"]

[tasks.kernel-test]
description = "Build the Strat9 kernel (debug profile) with runtime self-tests"
cwd = "workspace/kernel"
command = "cargo"
args = ["build", "--target", "${KERNEL_TARGET}", "--features", "selftest"]

[tasks.kernel-release]
description = "Build the Strat9 kernel (release profile)"
cwd = "workspace/kernel"
command = "cargo"
args = ["build", "--release", "--target", "${KERNEL_TARGET}"]

[tasks.kernel-dev-opt]
description = "Build the Strat9 kernel (dev-opt profile)"
cwd = "workspace/kernel"
command = "cargo"
args = ["build", "--profile", "dev-opt", "--target", "${KERNEL_TARGET}"]

[tasks.kernel-debug]
description = "Alias: build the Strat9 kernel (debug profile)"
alias = "kernel"

[tasks.check]
description = "Check kernel code without building"
cwd = "workspace/kernel"
command = "cargo"
args = ["check", "--target", "${KERNEL_TARGET}"]

[tasks.clippy]
description = "Run clippy on kernel code"
cwd = "workspace/kernel"
command = "cargo"
args = ["clippy", "--target", "${KERNEL_TARGET}"]

[tasks.fmt]
description = "Format all code"
command = "cargo"
args = ["fmt", "--all"]

# =============================================================================
# Image generation - Bootable disk image
# =============================================================================

[tasks.strate-ext4]
description = "Build the EXT4 userspace filesystem component (debug profile)"
cwd = "workspace/components/strate-fs-ext4"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-fs-ramfs]
description = "Build the RAM filesystem component (debug profile)"
cwd = "workspace/components/strate-fs-ramfs"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-silo-test]


description = "Build the first userspace init/test component (debug profile)"
cwd = "workspace/components/strate-silo-test"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]
[tasks.strate-mem-test]
description = "Build the memory stress test userspace component (debug profile)"
cwd = "workspace/components/strate-mem-test"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-init]
description = "Build the init process (debug profile)"
cwd = "workspace/components/strate-init"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-net]
description = "Build the network silo (debug profile)"
cwd = "workspace/components/strate-net"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-console-admin]


description = "Build the console-admin silo (debug profile)"
cwd = "workspace/components/strate-console-admin"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.dhcpd]
description = "Build the DHCP status monitor (debug profile)"
cwd = "workspace/components/netutils/dhcpd"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.ping]
description = "Build the ping utility (debug profile)"
cwd = "workspace/components/netutils/ping"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]
[tasks.strate-ext4-release]
description = "Build the EXT4 userspace filesystem component (release profile)"
cwd = "workspace/components/strate-fs-ext4"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-fs-ramfs-release]
description = "Build the RAM filesystem component (release profile)"
cwd = "workspace/components/strate-fs-ramfs"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-silo-test-release]


description = "Build the first userspace init/test component (release profile)"
cwd = "workspace/components/strate-silo-test"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]
[tasks.strate-mem-test-release]
description = "Build the memory stress test userspace component (release profile)"
cwd = "workspace/components/strate-mem-test"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-init-release]
description = "Build the init process (release profile)"
cwd = "workspace/components/strate-init"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-net-release]
description = "Build the network silo (release profile)"
cwd = "workspace/components/strate-net"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-console-admin-release]


description = "Build the console-admin silo (release profile)"
cwd = "workspace/components/strate-console-admin"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.dhcpd-release]
description = "Build the DHCP status monitor (release profile)"
cwd = "workspace/components/netutils/dhcpd"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.ping-release]
description = "Build the ping utility (release profile)"
cwd = "workspace/components/netutils/ping"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--release",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]
[tasks.strate-ext4-dev-opt]
description = "Build the EXT4 userspace filesystem component (dev-opt profile)"
cwd = "workspace/components/strate-fs-ext4"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-fs-ramfs-dev-opt]
description = "Build the RAM filesystem component (dev-opt profile)"
cwd = "workspace/components/strate-fs-ramfs"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-silo-test-dev-opt]
description = "Build the first userspace init/test component (dev-opt profile)"
cwd = "workspace/components/strate-silo-test"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]
[tasks.strate-mem-test-dev-opt]
description = "Build the memory stress test userspace component (dev-opt profile)"
cwd = "workspace/components/strate-mem-test"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-init-dev-opt]
description = "Build the init process (dev-opt profile)"
cwd = "workspace/components/strate-init"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-net-dev-opt]
description = "Build the network silo (dev-opt profile)"
cwd = "workspace/components/strate-net"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.strate-console-admin-dev-opt]
description = "Build the console-admin silo (dev-opt profile)"
cwd = "workspace/components/strate-console-admin"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.dhcpd-dev-opt]
description = "Build the DHCP status monitor (dev-opt profile)"
cwd = "workspace/components/netutils/dhcpd"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.ping-dev-opt]
description = "Build the ping utility (dev-opt profile)"
cwd = "workspace/components/netutils/ping"
command = "cargo"
args = [
    "build",
    "--target",
    "x86_64-unknown-none",
    "--profile",
    "dev-opt",
    "-Z",
    "build-std=core,alloc",
    "-Z",
    "build-std-features=compiler-builtins-mem",
]

[tasks.limine-image]

description = "Create bootable ISO/IMG with Limine + kernel"
dependencies = [
    "setup-limine",
    "kernel",
    "strate-ext4",
    "strate-fs-ramfs",
    "strate-silo-test",
    "strate-mem-test",
    "strate-init",
    "strate-console-admin",
    "strate-net",
    "dhcpd",
    "ping",
]
env = { STRAT9_IMAGE_BASENAME = "strat9-os" }
script_runner = "@shell"
script = ['''
bash tools/scripts/create-limine-image.sh
''']

[tasks.limine-image-test]

description = "Create bootable ISO/IMG with Limine + kernel (self-tests enabled)"
dependencies = [
    "setup-limine",
    "kernel-test",
    "strate-ext4",
    "strate-fs-ramfs",
    "strate-silo-test",
    "strate-mem-test",
    "strate-init",
    "strate-console-admin",
    "strate-net",
    "dhcpd",
    "ping",
]
env = { STRAT9_IMAGE_BASENAME = "strat9-os-test" }
script_runner = "@shell"
script = ['''
bash tools/scripts/create-limine-image.sh
''']

[tasks.limine-image-dev-opt]

description = "Create bootable ISO/IMG with Limine + kernel (dev-opt profile)"
dependencies = [
    "setup-limine",
    "kernel-dev-opt",
    "strate-ext4-dev-opt",
    "strate-fs-ramfs-dev-opt",
    "strate-silo-test-dev-opt",
    "strate-mem-test-dev-opt",
    "strate-init-dev-opt",
    "strate-console-admin-dev-opt",
    "strate-net-dev-opt",
    "dhcpd-dev-opt",
    "ping-dev-opt",
]
env = { STRAT9_IMAGE_BASENAME = "strat9-os", STRAT9_PROFILE = "dev-opt" }
script_runner = "@shell"
script = ['''
bash tools/scripts/create-limine-image.sh
''']

[tasks.limine-image-release]

description = "Create bootable ISO/IMG with Limine + kernel (release profile)"
dependencies = [
    "setup-limine",
    "kernel-release",
    "strate-ext4-release",
    "strate-fs-ramfs-release",
    "strate-silo-test-release",
    "strate-mem-test-release",
    "strate-init-release",
    "strate-console-admin-release",
    "strate-net-release",
    "dhcpd-release",
    "ping-release",
]
env = { STRAT9_IMAGE_BASENAME = "strat9-os", STRAT9_PROFILE = "release" }
script_runner = "@shell"
script = ['''
bash tools/scripts/create-limine-image.sh
''']

# Legacy disk image (kept for reference)
[tasks.disk-image]
description = "Create bootable disk image (.img) with bootloader + kernel - LEGACY"
dependencies = ["assemble-bootloader", "kernel"]
command = "powershell"
args = ["-ExecutionPolicy", "Bypass", "-File", "tools/scripts/create-image.ps1"]

[tasks.build-all]
description = "Compilation complete : Limine + kernel Rust + image disque/ISO"
dependencies = ["limine-image"]

# =============================================================================
# QEMU run tasks
# =============================================================================

[tasks.run-gui]
description = "Load QEMU with the Limine ISO (graphical interface) + EXT4 disk"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run-gui-net]
description = "Load QEMU with NAT networking (DHCP server enabled) + graphical interface"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-netdev",
    "user,id=net0,net=192.168.76.0/24,dhcpstart=192.168.76.9,dns=192.168.76.1",
    "-device",
    "e1000,netdev=net0,mac=52:54:00:12:34:56",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run-gui-release]
description = "Load QEMU with the Limine ISO (graphical interface) + EXT4 disk (release profile)"
dependencies = ["limine-image-release"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run-gui-dev-opt]
description = "Load QEMU with the Limine ISO (graphical interface) + EXT4 disk (dev-opt profile)"
dependencies = ["limine-image-dev-opt"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run-gui-smp]
description = "Load QEMU with the Limine ISO (graphical interface) + EXT4 disk — SMP 2 CPUs"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-smp",
    "2",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run-gui-smp-release]
description = "Load QEMU with the Limine ISO (graphical interface) + EXT4 disk — SMP 2 CPUs (release profile)"
dependencies = ["limine-image-release"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-smp",
    "2",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-netdev",
    "user,id=net0,net=192.168.76.0/24,dhcpstart=192.168.76.9,dns=192.168.76.1",
    "-device",
    "e1000,netdev=net0,mac=52:54:00:12:34:56",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run-gui-smp-dev-opt]
description = "Load QEMU with the Limine ISO (graphical interface) + EXT4 disk — SMP 2 CPUs (dev-opt profile)"
dependencies = ["limine-image-dev-opt"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-smp",
    "2",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu.log",
    "-d",
    "guest_errors",
]

[tasks.run]
description = "Load QEMU with the Limine ISO (text mode) + EXT4 disk"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-nographic",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu.log",
]

[tasks.run-net]
description = "Load QEMU with NAT networking (DHCP server enabled) + text mode"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-nographic",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-netdev",
    "user,id=net0,net=192.168.76.0/24,dhcpstart=192.168.76.9,dns=192.168.76.1",
    "-device",
    "e1000,netdev=net0,mac=52:54:00:12:34:56",
    "-D",
    "build/qemu.log",
]

[tasks.run-qemu]
description = "Alias: run QEMU with graphical window"
alias = "run-gui"

[tasks.run-qemu-headless]
description = "Alias: run QEMU in headless/text mode"
alias = "run"

[tasks.run-test]
description = "Load QEMU with the Limine ISO test build (graphical mode) + EXT4 disk"
dependencies = ["limine-image-test"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os-test.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu-test.log",
    "-d",
    "guest_errors",
]

[tasks.run-test-headless]
description = "Load QEMU with the Limine ISO test build (headless/text mode) + EXT4 disk"
dependencies = ["limine-image-test"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os-test.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-nographic",
    "-no-reboot",
    "-no-shutdown",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu-test.log",
]

[tasks.run-debug]
description = "Load QEMU in debug mode (GDB server on :1234) + EXT4 disk"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-gdb",
    "tcp::${QEMU_GDB_PORT}",
    "-S",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu-debug.log",
    "-d",
    "int,cpu_reset,guest_errors",
]

[tasks.run-debug-net]
description = "Load QEMU in debug mode with NAT networking (GDB server + DHCP)"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-no-reboot",
    "-no-shutdown",
    "-gdb",
    "tcp::${QEMU_GDB_PORT}",
    "-S",
    "-serial",
    "mon:stdio",
    "-netdev",
    "user,id=net0,net=192.168.76.0/24,dhcpstart=192.168.76.9,dns=192.168.76.1",
    "-device",
    "e1000,netdev=net0,mac=52:54:00:12:34:56",
    "-D",
    "build/qemu-debug.log",
    "-d",
    "int,cpu_reset,guest_errors",
]

[tasks.run-qemu-debug]
description = "Alias: run QEMU paused with GDB server"
alias = "run-debug"

[tasks.run-debug-headless]
description = "Load QEMU in debug mode (headless, paused, GDB server)"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-nographic",
    "-no-reboot",
    "-no-shutdown",
    "-gdb",
    "tcp::${QEMU_GDB_PORT}",
    "-S",
    "-serial",
    "mon:stdio",
    "-D",
    "build/qemu-debug.log",
    "-d",
    "int,cpu_reset,guest_errors",
]

[tasks.run-debug-net-headless]
description = "Load QEMU in debug mode with NAT networking (headless, GDB server + DHCP)"
dependencies = ["limine-image"]
command = "${QEMU}"
args = [
    "-cdrom",
    "build/strat9-os.iso",
    "-drive",
    "file=qemu-stuff/disk.img,format=raw,if=none,id=drv0,cache=none",
    "-device",
    "virtio-blk-pci,drive=drv0",
    "-machine",
    "q35",
    "-cpu",
    "qemu64",
    "-m",
    "256M",
    "-nographic",
    "-no-reboot",
    "-no-shutdown",
    "-gdb",
    "tcp::${QEMU_GDB_PORT}",
    "-S",
    "-serial",
    "mon:stdio",
    "-netdev",
    "user,id=net0,net=192.168.76.0/24,dhcpstart=192.168.76.9,dns=192.168.76.1",
    "-device",
    "e1000,netdev=net0,mac=52:54:00:12:34:56",
    "-D",
    "build/qemu-debug.log",
    "-d",
    "int,cpu_reset,guest_errors",
]

[tasks.gdb-kernel]
description = "Attach GDB to the paused QEMU kernel"
dependencies = ["kernel"]
command = "${GDB}"
args = [
    "target/x86_64-unknown-none/${STRAT9_PROFILE}/kernel",
    "-ex",
    "target remote :${QEMU_GDB_PORT}",
]

[tasks.test-boot]
description = "Quick boot test (10 seconds then stop)"
dependencies = ["limine-image"]
script_runner = "@shell"
script = ['''
bash tools/scripts/test-boot.sh
''']

# =============================================================================
# Cleanup
# =============================================================================

[tasks.clean]
description = "Clean all build artifacts"
script_runner = "@shell"
script = ['''
cargo clean
if [ -d "build" ]; then rm -rf "build"; fi
if [ -f "qemu.log" ]; then rm -f "qemu.log"; fi
echo "Clean terminé."
''']

# =============================================================================
# Development tasks
# =============================================================================

[tasks.doc]
description = "Generate and open the documentation"
cwd = "workspace/kernel"
command = "cargo"
args = ["doc", "--target", "${KERNEL_TARGET}", "--no-deps", "--open"]

[tasks.size]
description = "Display the size of the kernel and its sections"
dependencies = ["kernel"]
script_runner = "@shell"
script = ['''
kernel="target/x86_64-unknown-none/${STRAT9_PROFILE}/kernel"
if [ -f "$kernel" ]; then
    echo ""
    echo "=== Size of the kernel ==="
    echo ""
    size=$(stat -c%s "$kernel")
    size_kb=$((size / 1024))
    echo "  Taille totale : $size bytes ($size_kb KB)"
    echo ""
    echo "=== Sections ELF ==="
    echo ""
    size "$kernel"
    echo ""
fi
''']

# =============================================================================
# Default Task
# =============================================================================

[tasks.default]
description = "Build complet (bootloader + kernel + image)"
dependencies = ["build-all"]

[tasks.all]
alias = "default"
